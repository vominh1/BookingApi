<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>💳 Quản lý Thanh Toán</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background-color: #f9fafb;
        }

        h1, h2 {
            color: #333;
        }

        form {
            background: #ffffff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        label {
            display: inline-block;
            width: 140px;
            font-weight: bold;
        }

        input, select {
            padding: 6px;
            width: 250px;
            margin-bottom: 10px;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 5px;
            cursor: pointer;
        }

            button:hover {
                background: #0056b3;
            }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-top: 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }

        th {
            background: #007bff;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .report-box {
            background: #e7f1ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <h1>💳 Quản lý Thanh Toán</h1>

    <!-- Form ghi nhận thanh toán -->
    <form id="paymentForm">
        <h2>Ghi nhận thanh toán</h2>
        <div>
            <label>Mã Booking:</label>
            <input type="text" id="bookingCode" placeholder="VD: BK12345678" required>
        </div>
        <div>
            <label>Số tiền (VNĐ):</label>
          
            <input type="text" id="amount" placeholder="Nhập số tiền..." required>

        </div>
        <div>
            <label>Phương thức:</label>
            <select id="method">
                <option value="Tiền mặt">Tiền mặt</option>
                <option value="Chuyển khoản">Chuyển khoản</option>
                <option value="Thẻ">Thẻ</option>
            </select>
        </div>
        <div>
            <label>Mã giao dịch:</label>
            <input  type="text" id="transactionRef" readonly>
        </div>
        <button type="submit">💰 Ghi nhận</button>
    </form>

    <!-- Danh sách thanh toán -->
    <h2>Danh sách thanh toán</h2>
    <div>
        <label>Nhập mã Booking:</label>
        <input type="text" id="searchBookingCode">
        <button onclick="loadPayments()">🔍 Xem</button>
    </div>

    <table id="paymentsTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Số tiền (VNĐ)</th>
                <th>Phương thức</th>
                <th>Mã giao dịch</th>
                <th>Ngày thanh toán</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Báo cáo doanh thu -->
    <div class="report-box">
        <h2>📊 Báo cáo Doanh thu</h2>
        <form id="reportForm">
            <div>
                <label>Từ ngày:</label>
                <input type="date" id="fromDate" required>
            </div>
            <div>
                <label>Đến ngày:</label>
                <input type="date" id="toDate" required>
            </div>
            <button type="submit">📅 Xem báo cáo</button>
        </form>

        <div id="reportResult"></div>
    </div>

    <script>
        const apiBase = "https://localhost:44336/api/payments";
        async function randomTransactionRef() {
            return 'TX' + Math.random().toString(36).substr(2, 9).toUpperCase();
        }
        document.getElementById("paymentForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const bookingCode = document.getElementById("bookingCode").value.trim();
            const amountFormatted = document.getElementById("amount").value;
            const method = document.getElementById("method").value;
            const transactionRef = document.getElementById("transactionRef").value;
          
            const amount = parseAmount() ;
            const payLoad = { bookingCode, amount, paymentMethod: method, transactionRef };
            
            try {
                const res = await fetch(apiBase, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payLoad)
                });

                const data = await res.json();

                if (res.ok) {
                    alert(data.message);
                    document.getElementById("paymentForm").reset();
                } else {
                    alert("❌ " + (data.message || "Lỗi ghi nhận thanh toán."));
                }
            } catch (err) {
                console.error("Lỗi gửi thanh toán:", err);
                alert("Lỗi kết nối tới API.");
            }
        });

        async function loadPayments() {
            const bookingCode = document.getElementById("searchBookingCode").value.trim();
            if (!bookingCode) {
                alert("Vui lòng nhập mã Booking.");
                return;
            }
            try {
                const res = await fetch(`${apiBase}?bookingCode=${bookingCode}`);

                const data = await res.json();
                const tbody = document.querySelector("#paymentsTable tbody");
                tbody.innerHTML = "";
                if (data.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='5'>Không có thanh toán nào.</td></tr>";
                    return;
                }
                data.forEach(p => {
                    const row = `
                                            <tr>
                                                <td>${p.paymentId}</td>
                                                <td>${p.amount.toLocaleString("vi-VN") }</td>
                                                <td>${p.paymentMethod}</td>
                                                <td>${p.transactionRef}</td>
                                                <td>${new Date(p.paidAt).toLocaleString()}</td>
                                            </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (err) {
                console.error("Lỗi loadPayments:", err);
                alert("Lỗi kết nối đến API.");
            }
        }

        document.getElementById("reportForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const fromDate = document.getElementById("fromDate").value;
            const toDate = document.getElementById("toDate").value;

            if (!fromDate || !toDate) {
                alert("Vui lòng chọn đầy đủ ngày.");
                return;
            }

            try {
                const res = await fetch(`${apiBase}/report?from=${fromDate}&to=${toDate}`);
                const data = await res.json();

                if (res.ok) {
                    const totalTransactions = data.daily.reduce((acc, d) => acc + d.count, 0);
                    const totalRevenue = data.total.toLocaleString("vi-VN");

                    let dailyRows = "";
                    data.daily.forEach(d => {
                        dailyRows += `
                            <tr>
                                <td>${new Date(d.date).toLocaleDateString("vi-VN")}</td>
                                <td>${d.totalAmount.toLocaleString("vi-VN")} ₫</td>
                                <td>${d.count}</td>
                            </tr>`;
                    });

                    document.getElementById("reportResult").innerHTML = `
                        <h3>Kết quả từ ${new Date(data.from).toLocaleDateString("vi-VN")} đến ${new Date(data.to).toLocaleDateString("vi-VN")}</h3>
                        <p><strong>Tổng doanh thu:</strong> ${totalRevenue} ₫</p>
                        <p><strong>Số giao dịch:</strong> ${totalTransactions}</p>
                        <table border="1" style="border-collapse:collapse;width:100%;margin-top:10px;">
                            <thead>
                                <tr>
                                    <th>Ngày</th>
                                    <th>Doanh thu</th>
                                    <th>Số giao dịch</th>
                                </tr>
                            </thead>
                            <tbody>${dailyRows}</tbody>
                        </table>
                    `;
                } else {
                    alert("❌ " + (data.message || "Lỗi lấy báo cáo."));
                }
            } catch (err) {
                console.error("Lỗi lấy báo cáo:", err);
                alert("Lỗi kết nối tới API.");
            }
        });
            document.getElementById("amount").addEventListener("input", function (e) {
                let value = e.target.value;

                // 🔹 Loại bỏ mọi ký tự không phải số
                value = value.replace(/[^\d]/g, "");

                // 🔹 Format lại có dấu phẩy
                if (value) {
                    value = parseInt(value, 10).toLocaleString("vi-VN");
                }

                e.target.value = value;
            });
        function parseAmount() {
            const amountFormatted = document.getElementById("amount").value;
            const amount = parseFloat(amountFormatted.replace(/\./g, ""));  // Sửa regex: escape \. để xóa dấu chấm

            if (isNaN(amount)) {
                console.error("Giá trị không hợp lệ!");
                return 0;  // Hoặc xử lý lỗi tùy bạn
            }

            console.log("Số sạch:", amount);  // Ví dụ: "1.234.567" → 1234567
            return amount;
        }
        window.onload = async function () {
            document.getElementById("transactionRef").value = await randomTransactionRef();
        };
    </script>
</body>
</html>