<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>💳 Quản lý Thanh Toán</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            text-align: center;
        }

            .header h1 {
                color: #667eea;
                font-size: 2.5em;
                font-weight: 700;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 15px;
            }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

            .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 25px 70px rgba(0, 0, 0, 0.4);
            }

        .card-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                color: #555;
                font-weight: 600;
                font-size: 0.95em;
            }

            .form-group input,
            .form-group select {
                width: 100%;
                padding: 12px 16px;
                border: 2px solid #e0e0e0;
                border-radius: 10px;
                font-size: 1em;
                transition: all 0.3s ease;
                background: white;
            }

                .form-group input:focus,
                .form-group select:focus {
                    outline: none;
                    border-color: #667eea;
                    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
                }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            }

            .btn:active {
                transform: translateY(0);
            }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

            .search-box input {
                flex: 1;
                padding: 12px 16px;
                border: 2px solid #e0e0e0;
                border-radius: 10px;
                font-size: 1em;
            }

            .search-box button {
                width: auto;
                padding: 12px 24px;
            }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            overflow: hidden;
            border-radius: 10px;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95em;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
        }

        tr:hover {
            background: #f8f9ff;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .daily-table {
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.1em;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-cash {
            background: #d4edda;
            color: #155724;
        }

        .badge-transfer {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-card {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

            .loading.active {
                display: block;
            }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div id="sidebar"></div>  <!-- Menu bên trái -->
        <div class="main-content">
            <div id="header"></div>  <!-- Header trên -->
            <div class="content-wrapper">
                <div class="container">
                    <div class="header">
                        <h1>💳 Hệ thống Quản lý Thanh Toán</h1>
                    </div>

                    <div class="grid">
                        <!-- Form ghi nhận thanh toán -->
                        <div class="card">
                            <h2 class="card-title">➕ Ghi nhận thanh toán mới</h2>
                            <form id="paymentForm">
                                <div class="form-group">
                                    <label>Mã Booking</label>
                                    <input type="text" id="bookingCode" placeholder="VD: BK12345678" required>
                                </div>
                                <div class="form-group">
                                    <label>Số tiền (VNĐ)</label>
                                    <input type="text" id="amount" placeholder="Nhập số tiền..." required>
                                </div>
                                <div class="form-group">
                                    <label>Phương thức thanh toán</label>
                                    <select id="method" required>
                                        <option value="Tiền mặt">💵 Tiền mặt</option>
                                        <option value="Chuyển khoản">🏦 Chuyển khoản</option>
                                        <option value="Thẻ">💳 Thẻ</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Mã giao dịch</label>
                                    <input type="text" id="transactionRef" readonly>
                                </div>
                                <button type="submit" class="btn">💰 Ghi nhận thanh toán</button>
                            </form>
                        </div>

                        <!-- Danh sách thanh toán -->
                        <div class="card">
                            <h2 class="card-title">📋 Danh sách thanh toán</h2>
                            <div class="search-box">
                                <input type="text" id="searchBookingCode" placeholder="Nhập mã Booking...">
                                <button class="btn" onclick="loadPayments()">🔍 Tìm kiếm</button>
                            </div>
                            <div class="loading" id="loadingPayments">⏳ Đang tải...</div>
                            <div style="overflow-x: auto;">
                                <table id="paymentsTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Số tiền</th>
                                            <th>Phương thức</th>
                                            <th>Mã GD</th>
                                            <th>Ngày</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="5" class="empty-state">
                                                Nhập mã Booking để xem danh sách thanh toán
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Báo cáo doanh thu -->
                        <div class="card full-width">
                            <h2 class="card-title">📊 Báo cáo Doanh thu</h2>
                            <form id="reportForm">
                                <div class="grid">
                                    <div class="form-group">
                                        <label>Từ ngày</label>
                                        <input type="date" id="fromDate" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Đến ngày</label>
                                        <input type="date" id="toDate" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-secondary">📅 Xem báo cáo</button>
                            </form>

                            <div class="loading" id="loadingReport">⏳ Đang tải báo cáo...</div>
                            <div id="reportResult"></div>
                        </div>
                    </div>
                </div>

            </div>
            <div id="footer"></div>  <!-- Footer dưới -->
        </div>
    </div>



    <script>
        async function loadLayout() {
            try {
                // Load header
                const headerResponse = await fetch("../layouts/header.html");
                const headerHTML = await headerResponse.text();
                document.getElementById("header").innerHTML = headerHTML;

                // Load sidebar
                const sidebarResponse = await fetch("../layouts/sidebar.html");
                const sidebarHTML = await sidebarResponse.text();
                document.getElementById("sidebar").innerHTML = sidebarHTML;

                // Load footer
                const footerResponse = await fetch("../layouts/footer.html");
                const footerHTML = await footerResponse.text();
                document.getElementById("footer").innerHTML = footerHTML;

                // Highlight active menu
                highlightActiveMenu();
            } catch (error) {
                console.error("Error loading layouts:", error);
            }
        }

        function highlightActiveMenu() {
            setTimeout(() => {
                const links = document.querySelectorAll(".nav-link");
                const savedPage = localStorage.getItem("activePage");

                // Reset tất cả
                links.forEach(l => l.classList.remove("active"));

                // Nếu có mục đã lưu → highlight
                if (savedPage) {
                    links.forEach(l => {
                        if (l.dataset.page === savedPage) {
                            l.classList.add("active");
                        }
                    });
                }

                // Khi click → lưu lại
                links.forEach(link => {
                    link.addEventListener("click", function () {
                        localStorage.setItem("activePage", this.dataset.page);
                    });
                });

            }, 50); // ⭐ chờ DOM cập nhật sau khi load sidebar
        }


        // Load layout khi trang ready
        document.addEventListener('DOMContentLoaded', () => {
            loadLayout();
            loadBookings();
        });
    </script>
    <script>
        const apiBase = "https://localhost:44336/api/payments";

        async function randomTransactionRef() {
            return 'TX' + Math.random().toString(36).substr(2, 9).toUpperCase();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' ₫';
        }

        function getPaymentBadge(method) {
            const badges = {
                'Tiền mặt': 'badge-cash',
                'Chuyển khoản': 'badge-transfer',
                'Thẻ': 'badge-card'
            };
            return `<span class="badge ${badges[method] || ''}">${method}</span>`;
        }

        document.getElementById("amount").addEventListener("input", function (e) {
            let value = e.target.value.replace(/[^\d]/g, "");
            if (value) {
                value = parseInt(value, 10).toLocaleString("vi-VN");
            }
            e.target.value = value;
        });

        function parseAmount() {
            const amountFormatted = document.getElementById("amount").value;
            const amount = parseFloat(amountFormatted.replace(/\./g, ""));
            return isNaN(amount) ? 0 : amount;
        }

        document.getElementById("paymentForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const bookingCode = document.getElementById("bookingCode").value.trim();
            const amount = parseAmount();
            const method = document.getElementById("method").value;
            const transactionRef = document.getElementById("transactionRef").value;

            if (amount <= 0) {
                alert("❌ Vui lòng nhập số tiền hợp lệ!");
                return;
            }

            const payLoad = { bookingCode, amount, paymentMethod: method, transactionRef };

            try {
                const res = await fetch(apiBase, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payLoad)
                });

                const data = await res.json();

                if (res.ok) {
                    alert("✅ " + data.message);
                    document.getElementById("paymentForm").reset();
                    document.getElementById("transactionRef").value = await randomTransactionRef();
                } else {
                    alert("❌ " + (data.message || "Lỗi ghi nhận thanh toán."));
                }
            } catch (err) {
                console.error("Lỗi gửi thanh toán:", err);
                alert("❌ Lỗi kết nối tới API.");
            }
        });

        async function loadPayments() {
            const bookingCode = document.getElementById("searchBookingCode").value.trim();
            if (!bookingCode) {
                alert("⚠️ Vui lòng nhập mã Booking.");
                return;
            }

            const loading = document.getElementById("loadingPayments");
            const tbody = document.querySelector("#paymentsTable tbody");

            loading.classList.add("active");

            try {
                const res = await fetch(`${apiBase}?bookingCode=${bookingCode}`);
                const data = await res.json();

                tbody.innerHTML = "";

                if (data.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='5' class='empty-state'>Không tìm thấy thanh toán nào</td></tr>";
                    return;
                }

                data.forEach(p => {
                    const row = `
                                <tr>
                                    <td><strong>#${p.paymentId}</strong></td>
                                    <td><strong>${formatCurrency(p.amount)}</strong></td>
                                    <td>${getPaymentBadge(p.paymentMethod)}</td>
                                    <td><code>${p.transactionRef}</code></td>
                                    <td>${new Date(p.paidAt).toLocaleString('vi-VN')}</td>
                                </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (err) {
                console.error("Lỗi loadPayments:", err);
                alert("❌ Lỗi kết nối đến API.");
                tbody.innerHTML = "<tr><td colspan='5' class='empty-state'>Lỗi tải dữ liệu</td></tr>";
            } finally {
                loading.classList.remove("active");
            }
        }

        document.getElementById("reportForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const fromDate = document.getElementById("fromDate").value;
            const toDate = document.getElementById("toDate").value;

            if (!fromDate || !toDate) {
                alert("⚠️ Vui lòng chọn đầy đủ ngày.");
                return;
            }

            const loading = document.getElementById("loadingReport");
            const resultDiv = document.getElementById("reportResult");

            loading.classList.add("active");
            resultDiv.innerHTML = "";

            try {
                const res = await fetch(`${apiBase}/report?from=${fromDate}&to=${toDate}`);
                const data = await res.json();

                if (res.ok) {
                    const totalTransactions = data.daily.reduce((acc, d) => acc + d.count, 0);

                    let dailyRows = "";
                    data.daily.forEach(d => {
                        dailyRows += `
                                    <tr>
                                        <td><strong>${new Date(d.date).toLocaleDateString("vi-VN")}</strong></td>
                                        <td><strong>${formatCurrency(d.totalAmount)}</strong></td>
                                        <td><span class="badge badge-transfer">${d.count} giao dịch</span></td>
                                    </tr>`;
                    });

                    resultDiv.innerHTML = `
                                <div class="stats">
                                    <div class="stat-card">
                                        <div class="stat-label">💰 Tổng doanh thu</div>
                                        <div class="stat-value">${formatCurrency(data.total)}</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-label">📊 Số giao dịch</div>
                                        <div class="stat-value">${totalTransactions}</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-label">📅 Khoảng thời gian</div>
                                        <div class="stat-value">${data.daily.length} ngày</div>
                                    </div>
                                </div>
                                <div class="daily-table">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Ngày</th>
                                                <th>Doanh thu</th>
                                                <th>Số giao dịch</th>
                                            </tr>
                                        </thead>
                                        <tbody>${dailyRows}</tbody>
                                    </table>
                                </div>
                            `;
                } else {
                    alert("❌ " + (data.message || "Lỗi lấy báo cáo."));
                }
            } catch (err) {
                console.error("Lỗi lấy báo cáo:", err);
                alert("❌ Lỗi kết nối tới API.");
            } finally {
                loading.classList.remove("active");
            }
        });

        window.onload = async function () {
            document.getElementById("transactionRef").value = await randomTransactionRef();
        };
    </script>
</body>
</html>
