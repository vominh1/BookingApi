<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Booking</title>

    <!-- CSS gốc của bạn -->
    <link href="../css/Style.css" rel="stylesheet" />

    <!-- CSS cho layout (header, sidebar, footer) -->
  
    <link href="/Layouts/css/style.css" rel="stylesheet" />

</head>
<body>
    <!-- Thêm cấu trúc layout -->
    <div class="page-container">
        <!-- Sidebar -->
        <div id="sidebar"></div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div id="header"></div>

            <!-- Nội dung gốc của bạn -->
            <div class="content-wrapper">
                <div class="container">
                    <div class="header">
                        <h1>📋 Danh sách Booking</h1>
                        <button class="create-btn" onclick="createBooking()">
                            ➕ Tạo Booking Mới
                        </button>
                    </div>

                    <div class="booking-list" id="bookingList">
                        <div class="loading-state">⏳ Đang tải dữ liệu...</div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div id="footer"></div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal()"></div>
    <div class="modal" id="detailModal">
        <div class="modal-header">
            <h2>📄 Chi tiết Booking</h2>
            <button class="close-btn" onclick="closeModal()">×</button>
        </div>
        <div class="modal-content" id="modalContent">
            <p>Đang tải...</p>
        </div>
        <div class="modal-footer">
            <button onclick="closeModal()">Đóng</button>
        </div>
    </div>

    <script>
        async function loadLayout() {
            try {
                const headerHTML = await (await fetch("../layouts/header.html")).text();
                document.getElementById("header").innerHTML = headerHTML;
                const sidebarHTML = await (await fetch("../layouts/sidebar.html")).text();
                document.getElementById("sidebar").innerHTML = sidebarHTML;
                highlightActiveMenu();
                const footerHTML = await (await fetch("../layouts/footer.html")).text();
                document.getElementById("footer").innerHTML = footerHTML;

            } catch (error) {
                console.error("Error loading layouts:", error);
            }
        }


        function highlightActiveMenu() {
            const links = document.querySelectorAll(".nav-link");
            const savedPage = localStorage.getItem("activePage");
            links.forEach(l => l.classList.remove("active"));
            if (savedPage) {
                links.forEach(l => {
                    if (l.dataset.page === savedPage) {
                        l.classList.add("active");
                    }
                });
            }
            links.forEach(link => {
                link.addEventListener("click", function () {
                    localStorage.setItem("activePage", this.dataset.page);
                });
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            loadLayout();
            loadBookingsPaginated();

        });
    </script>
    <script>
        let offset = 0;
        let pageSize = 7;
        let isLoading = false;
        let hasMore = true;

    </script>
    <!-- JavaScript gốc của bạn -->
    <script>
        const API_BASE = "https://localhost:44336/api/booking";

        function createBooking() {
            window.location.href = 'createBooking.html';
        }

        // hàm load all bookings không phân trang
        //async function loadBookings() {
        //    try {
        //        const response = await fetch(API_BASE);
        //        if (!response.ok) throw new Error("Không thể tải dữ liệu: " + response.status);
        //        const data = await response.json();

        //        const list = Array.isArray(data) ? data : (data.items || [data]);
        //        renderBookings(list);
        //    } catch (err) {
        //        console.error(err);
        //        document.getElementById('bookingList').innerHTML =
        //            '<div class="empty-state">❌ Lỗi tải danh sách: ' + err.message + '</div>';
        //    }
        //}

        // Hàm load bookings có phân trang ( offset = 0 và pagesize = 7)
        async function loadBookingsPaginated() {
            if (!hasMore || isLoading) return;

            isLoading = true;

            try {
                const response = await fetch(`${API_BASE}?offset=${offset}&pageSize=${pageSize}`);
                const data = await response.json();

                const list = data.items || [];

                if (list.length < pageSize) {
                    hasMore = false; // hết dữ liệu
                }

                renderBookings(list, true);  // append chứ không clear

                offset += pageSize;

            } catch (err) {
                console.error("Lỗi tải:", err);
            }

            isLoading = false;
        }
        // Hàm hiển thị danh sách booking
        function renderBookings(bookings, append = false) {
            const container = document.getElementById('bookingList');

            if (!append) container.innerHTML = '';

            bookings.forEach(b => {
                const bookingCode = b.bookingCode || b.BookingCode;
                const created = b.createdAt || b.CreatedAt;
                const date = new Date(created).toLocaleDateString('vi-VN');
                const total = b.totalAmount || b.TotalAmount;
                const statusName = b.statusName || b.StatusName;

                const card = document.createElement('div');
                card.className = 'booking-card';
                card.innerHTML = `
                                    <div class="booking-code">${escapeHtml(bookingCode)}</div>
                                    <div class="booking-info">
                                        <div class="info-item">
                                            <span class="info-label">📅 Ngày đặt</span>
                                            <span class="info-value">${escapeHtml(date)}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">📊 Trạng thái</span>
                                            <span class="info-value">${escapeHtml(statusName)}</span>
                                        </div>
                                    </div>
                                    <div class="booking-total">
                                        <span class="total-label">💰 Tổng cộng</span>
                                        <span class="total-value">${formatMoney(total)}</span>
                                    </div>
                                    <div class="booking-actions">
                                        <button class="action-btn" onclick="viewDetail('${bookingCode}')">Xem chi tiết</button>
                                    </div>`;
                container.appendChild(card);
            });
        }
        // Sự kiện cuộn trang để tải thêm dữ liệu khi gần cuối trang (với mỗi lần load là 1s )
        window.addEventListener('scroll', () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
                setTimeout(() => {
                    loadBookingsPaginated();
                }, 1000);

            }
        });


        async function viewDetail(bookingCode) {
            if (!bookingCode) {
                alert('Không tìm thấy mã booking.');
                return;
            }

            const overlay = document.getElementById('modalOverlay');
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('modalContent');

            overlay.style.display = 'block';
            modal.style.display = 'block';
            content.innerHTML = '<div style="text-align: center; padding: 40px;">⏳ Đang tải chi tiết...</div>';

            try {
                const url = `${API_BASE}/bycode/${encodeURIComponent(bookingCode)}`;
                const resp = await fetch(url);
                if (resp.status === 404) {
                    content.innerHTML = `<p style="text-align: center; color: #f44336;">❌ Không tìm thấy booking với mã <strong>${escapeHtml(bookingCode)}</strong>.</p>`;
                    return;
                }
                if (!resp.ok) throw new Error('Lỗi khi gọi API: ' + resp.status);

                const data = await resp.json();
                const b = data.Booking ?? data;
                const services = data.services ?? [];

                const bookingId = b.booking?.bookingId ?? b.booking?.BookingId ?? '';
                const bookingCodeResp = b.bookingCode ?? b.BookingCode ?? bookingCode;
                const created = b.booking?.createdAt ?? b.booking?.CreatedAt ?? b.created_at;
                const createdStr = created ? new Date(created).toLocaleString('vi-VN') : '';
                const statusName = b.booking?.statusName ?? b.booking?.StatusName ?? '';
                const custId = b.booking?.customerId ?? b.booking?.CustomerId ?? '';
                const fullName = b.booking?.fullName ?? b.booking?.FullName ?? b.booking?.Fullname ?? '';
                const email = b.booking?.email ?? b.booking?.Email ?? '';
                const phone = b.booking?.phone ?? b.booking?.Phone ?? '';
                const total = b.booking?.totalAmount ?? b.booking?.TotalAmount ?? b.booking?.total ?? 0;

                const groupedServices = Object.values(
                    services.reduce((acc, s) => {
                        if (!acc[s.serviceId]) {
                            acc[s.serviceId] = {
                                name: s.name,
                                unitPrice: s.unitPrice,
                                quantity: 0
                            };
                        }
                        acc[s.serviceId].quantity += s.quantity;
                        return acc;
                    }, {})
                );

                let serviceHtml = '';
                if (groupedServices.length > 0) {
                    const totalService = groupedServices.reduce(
                        (sum, s) => sum + s.unitPrice * s.quantity, 0
                    );

                    serviceHtml = `
                                                                            <div class="modal-section">
                                                                                <h3>🛎️ Dịch vụ kèm theo</h3>
                                                                                <table class="service-table">
                                                                                    <thead>
                                                                                        <tr>
                                                                                            <th>Tên dịch vụ</th>
                                                                                            <th style="text-align: center;">Số lượng</th>
                                                                                            <th style="text-align: right;">Đơn giá</th>
                                                                                            <th style="text-align: right;">Thành tiền</th>
                                                                                        </tr>
                                                                                    </thead>
                                                                                    <tbody>
                                                                                        ${groupedServices.map(s => `
                                                                                            <tr>
                                                                                                <td>${escapeHtml(s.name)}</td>
                                                                                                <td style="text-align: center;">${s.quantity}</td>
                                                                                                <td style="text-align: right;">${formatMoney(s.unitPrice)}</td>
                                                                                                <td style="text-align: right;">${formatMoney(s.unitPrice * s.quantity)}</td>
                                                                                            </tr>
                                                                                        `).join('')}
                                                                                    </tbody>
                                                                                    <tfoot>
                                                                                        <tr>
                                                                                            <td colspan="3" style="text-align: right;">💎 Tổng cộng:</td>
                                                                                            <td style="text-align: right;">${formatMoney(totalService)}</td>
                                                                                        </tr>
                                                                                    </tfoot>
                                                                                </table>
                                                                            </div>
                                                                        `;
                } else {
                    serviceHtml = `
                                                                            <div class="modal-section">
                                                                                <h3>🛎️ Dịch vụ kèm theo</h3>
                                                                                <p style="text-align: center; color: #999; padding: 20px;">Không có dịch vụ nào.</p>
                                                                            </div>
                                                                        `;
                }

                content.innerHTML = `
                                                                        <div class="modal-row">
                                                                            <span class="modal-label">📋 Mã Booking:</span>
                                                                            <span class="modal-value">${escapeHtml(bookingCodeResp)}</span>
                                                                        </div>
                                                                        <div class="modal-row">
                                                                            <span class="modal-label">🆔 ID Booking:</span>
                                                                            <span class="modal-value">${escapeHtml(bookingId)}</span>
                                                                        </div>
                                                                        <div class="modal-row">
                                                                            <span class="modal-label">📅 Ngày tạo:</span>
                                                                            <span class="modal-value">${escapeHtml(createdStr)}</span>
                                                                        </div>
                                                                        <div class="modal-row">
                                                                            <span class="modal-label">📊 Trạng thái:</span>
                                                                            <span class="modal-value">${escapeHtml(statusName)}</span>
                                                                        </div>
                                                                        <div class="modal-row">
                                                                            <span class="modal-label">💰 Tổng tiền:</span>
                                                                            <span class="modal-value">${formatMoney(total)}</span>
                                                                        </div>
                                                                        <div class="modal-section">
                                                                            <h3>👤 Thông tin khách hàng</h3>
                                                                            <div class="modal-row">
                                                                                <span class="modal-label">🆔 ID Khách hàng:</span>
                                                                                <span class="modal-value">${escapeHtml(custId)}</span>
                                                                            </div>
                                                                            <div class="modal-row">
                                                                                <span class="modal-label">👨 Họ tên:</span>
                                                                                <span class="modal-value">${escapeHtml(fullName)}</span>
                                                                            </div>
                                                                            <div class="modal-row">
                                                                                <span class="modal-label">📧 Email:</span>
                                                                                <span class="modal-value">${escapeHtml(email)}</span>
                                                                            </div>
                                                                            <div class="modal-row">
                                                                                <span class="modal-label">📱 SĐT:</span>
                                                                                <span class="modal-value">${escapeHtml(phone)}</span>
                                                                            </div>
                                                                        </div>
                                                                        ${serviceHtml}
                                                                    `;
            } catch (err) {
                console.error(err);
                content.innerHTML = `<p style="color: #f44336; text-align: center; padding: 20px;">❌ Có lỗi: ${escapeHtml(err.message)}</p>`;
            }
        }

        function closeModal() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('detailModal').style.display = 'none';
        }

        function formatMoney(amount) {
            if (!amount || isNaN(amount)) return '0 ₫';
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
    </script>
</body>
</html>